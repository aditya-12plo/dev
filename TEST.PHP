BEGIN
	DECLARE DONE, DTL_DONE INT DEFAULT FALSE; 
	DECLARE ISEXIST INT(18);
	DECLARE V_KD_APRF VARCHAR(20) DEFAULT 'SENTUBAHSTATUS';
	DECLARE V_STR_DATA TEXT DEFAULT NULL;
	
	DECLARE V_NO_UBAH_STATUS, V_KD_GUDANG_ASAL, V_KD_GUDANG_TUJUAN, V_NM_LENGKAP, V_KD_ORGANISASI, V_NAMA_ORGANISASI, V_ALAMAT, V_EMAIL, V_NPWP, V_NOTELP, V_NOFAX, V_ID_KAPAL,V_NAMA_KAPAL, V_CALL_SIGN, V_NO_VOY_FLIGHT, V_TGL_TIBA, V_NO_BC11, V_TGL_BC11, V_TGL_UBAH_STATUS VARCHAR(500) DEFAULT NULL;
	DECLARE V_NO_CONT, V_UKURAN, V_WK_REKAM VARCHAR(500) DEFAULT NULL;	
	
	DECLARE CCURSOR CURSOR FOR SELECT A.NO_UBAH_STATUS, A.KD_GUDANG_ASAL, A.KD_GUDANG_TUJUAN, B.NM_LENGKAP, 
									   C.ID, C.NAMA, C.ALAMAT, C.EMAIL, C.NPWP, C.NOTLP, C.NOFAX, A.ID_KAPAL, A.NAMA_KAPAL,
										A.CALL_SIGN, A.NO_VOY_FLIGHT, DATE_FORMAT(A.TGL_TIBA,'%Y%m%d') AS TGL_TIBA,
										A.NO_BC11, DATE_FORMAT(A.TGL_BC11,'%Y%m%d') AS TGL_BC11, DATE_FORMAT(A.TGL_UBAH_STATUS,'%Y%m%d') AS TGL_UBAH_STATUS
										FROM t_ubah_status A
									   INNER JOIN app_user B ON B.ID=A.ID_USER
									   INNER JOIN t_organisasi C ON C.ID=B.KD_ORGANISASI
									   WHERE A.KD_STATUS = '1';
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = TRUE;
		OPEN CCURSOR;
		CCURSOR_LOOP: LOOP
			FETCH CCURSOR INTO V_NO_UBAH_STATUS, V_KD_GUDANG_ASAL, V_KD_GUDANG_TUJUAN, V_NM_LENGKAP, V_KD_ORGANISASI, V_NAMA_ORGANISASI, V_ALAMAT, V_EMAIL, V_NPWP, V_NOTELP, V_NOFAX, V_ID_KAPAL,V_NAMA_KAPAL, V_CALL_SIGN, V_NO_VOY_FLIGHT, V_TGL_TIBA, V_NO_BC11, V_TGL_BC11, V_TGL_UBAH_STATUS;
			IF DONE THEN
				LEAVE CCURSOR_LOOP;
			END IF;
			
			SET V_STR_DATA = NULL;	
			SET V_STR_DATA = '<?xml version="1.0" encoding="UTF-8"?>';
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<DOCUMENT xmlns="loadubahstatus.xsd">');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<UBAHSTATUS>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<HEADER>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NO_UBAH_STATUS>',IFNULL(V_NO_UBAH_STATUS,''),'</NO_UBAH_STATUS>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<KD_GUDANG_ASAL>',IFNULL(V_KD_GUDANG_ASAL,''),'</KD_GUDANG_ASAL>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<KD_GUDANG_TUJUAN>',IFNULL(V_KD_GUDANG_TUJUAN,''),'</KD_GUDANG_TUJUAN>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NM_LENGKAP>',IFNULL(V_NM_LENGKAP,''),'</NM_LENGKAP>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NO_SURAT>',IFNULL(V_NO_SURAT,''),'</NO_SURAT>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<KD_ORGANISASI>',IFNULL(V_KD_ORGANISASI,''),'</KD_ORGANISASI>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NAMA_ORGANISASI>',IFNULL(V_NAMA_ORGANISASI,''),'</NAMA_ORGANISASI>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<ALAMAT>',IFNULL(V_ALAMAT,''),'</ALAMAT>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<EMAIL>',IFNULL(V_EMAIL,''),'</EMAIL>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NPWP>',IFNULL(V_NO_NPWP,''),'</NPWP>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NOTELP>',IFNULL(V_NOTELP,''),'</NOTELP>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NOFAX>',IFNULL(V_NOFAX,''),'</NOFAX>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<ID_KAPAL>',IFNULL(V_ID_KAPAL,''),'</ID_KAPAL>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NAMA_KAPAL>',IFNULL(V_NAMA_KAPAL,''),'</NAMA_KAPAL>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<CALL_SIGN>',IFNULL(V_CALL_SIGN,''),'</CALL_SIGN>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NO_VOY_FLIGHT>',IFNULL(V_NO_VOY_FLIGHT,''),'</NO_VOY_FLIGHT>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<TGL_TIBA>',IFNULL(V_TGL_TIBA,''),'</TGL_TIBA>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<NO_BC11>',IFNULL(V_NO_BC11,''),'</NO_BC11>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<TGL_BC11>',IFNULL(V_TGL_BC11,''),'</TGL_BC11>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'<TGL_UBAH_STATUS>',IFNULL(V_TGL_UBAH_STATUS,''),'</TGL_UBAH_STATUS>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'</HEADER>');
			
			BLOCK2: BEGIN
				DECLARE CDTL CURSOR FOR SELECTNO_CONT,UKURAN, WK_REKAM
										FROM t_no_kontainer WHERE NO_UBAH_STATUS = V_NO_UBAH_STATUS;
				DECLARE CONTINUE HANDLER FOR NOT FOUND SET DTL_DONE = TRUE;
				SET V_STR_DATA = CONCAT(V_STR_DATA,'<DETIL>');
				OPEN CDTL;
					CDTL_LOOP: LOOP
						FETCH CDTL INTO V_NO_CONT, V_UKURAN, V_WK_REKAM;
						IF DTL_DONE THEN
							LEAVE CDTL_LOOP;
						END IF;
						
							SET V_STR_DATA = CONCAT(V_STR_DATA,'<CONTAINER>');
							SET V_STR_DATA = CONCAT(V_STR_DATA,'<NO_CONT>',IFNULL(V_NO_CONT,''),'</NO_CONT>');
							SET V_STR_DATA = CONCAT(V_STR_DATA,'<UK_CONT>',IFNULL(V_UKURAN,''),'</UK_CONT>');
							SET V_STR_DATA = CONCAT(V_STR_DATA,'<WK_REKAM>',IFNULL(V_WK_REKAM,''),'</WK_REKAM>');
							SET V_STR_DATA = CONCAT(V_STR_DATA,'</CONTAINER>');
						
						
					END LOOP CDTL_LOOP;
				CLOSE CDTL;		
				SET V_STR_DATA = CONCAT(V_STR_DATA,'</DETIL>');
			END BLOCK2;			
			
			SET V_STR_DATA = CONCAT(V_STR_DATA,'</UBAHSTATUS>');
			SET V_STR_DATA = CONCAT(V_STR_DATA,'</DOCUMENT>');
		
			INSERT INTO postbox (SNRF, KD_APRF, KD_ORG_SENDER, KD_ORG_RECEIVER, STR_DATA, TGL_STATUS)
			VALUES (V_REF_NUMBER, V_KD_APRF, V_KD_ORG_SENDER, V_KD_ORG_RECEIVER, V_STR_DATA, NOW());
			
			UPDATE t_request_batal_plp_hdr SET REF_NUMBER = V_REF_NUMBER, KD_STATUS = '300', TGL_STATUS = NOW()
			WHERE ID = V_ID;
			
		END LOOP CCURSOR_LOOP;
	CLOSE CCURSOR;	

END

 <?xml version="1.0" encoding="utf-8"?>
 <DOCUMENT xmlns="loadubahstatus.xsd">
 <LOADUBAHSTATUS>
 <HEADER>
 <NO_UBAH_STATUS>ST20170210155617</NO_UBAH_STATUS>
 <KD_GUDANG_ASAL>CART</KD_GUDANG_ASAL>
 <KD_GUDANG_TUJUAN>ARN1</KD_GUDANG_TUJUAN>
 <NM_LENGKAP>SUPER ADMINISTRATOR APLIKASI</NM_LENGKAP>
 <KD_ORGANISASI>3</KD_ORGANISASI>
 <NAMA_ORGANISASI></NAMA_ORGANISASI>
 <ALAMAT>TJ. PRIOK</ALAMAT>
 <EMAIL>-</EMAIL>
 <NPWP>000000000000002</NPWP>
 <NOTELP>0211983272</NOTELP>
 <NOFAX>0211983272</NOFAX>
 <NAMA_KAPAL>JARING JANGKAR</NAMA_KAPAL>
 <NO_VOY_FLIGHT>AAA</NO_VOY_FLIGHT>
 <TGL_TIBA>2017-02-07</TGL_TIBA>
 <NO_BC11>AAAA</NO_BC11>
 <TGL_BC11>2017-02-15</TGL_BC11>
 <TGL_UBAH_STATUS>2017-02-17</TGL_UBAH_STATUS>
 </HEADER> 
 <DETIL>
 <CONTAINER> 
 <NO_CONT>1</NO_CONT>
 <UKURAN>1</UKURAN>
 <WK_REKAM>2017-02-10 17:00:53</WK_REKAM>
 </CONTAINER>
 <CONTAINER>
 <NO_CONT>1</NO_CONT>
 <UKURAN>1</UKURAN>
 <WK_REKAM>2017-02-10 17:00:53</WK_REKAM>
 </CONTAINER>
 </DETIL>
 </LOADUBAHSTATUS>
 
 </DOCUMENT>

