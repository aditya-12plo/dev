<?xml version="1.0" encoding="UTF-8"?><DOCUMENT><RESPONLCL><HEADER><KD_GUDANG_ASAL>CART</KD_GUDANG_ASAL><KD_GUDANG_TUJUAN>207X</KD_GUDANG_TUJUAN><KD_ORGANISASI>1</KD_ORGANISASI><EMAIL>CUSTOMERS@EDI-INDONESIA.CO.ID</EMAIL><NPWP>000000000000000</NPWP><NAMA_KAPAL>5VFT67B</NAMA_KAPAL><NO_VOY_FLIGHT>768</NO_VOY_FLIGHT><NO_BC11>6789</NO_BC11><ALASAN_TOLAK>KONTAINER SUDAH PERNAH DIAJUKAN</ALASAN_TOLAK></HEADER><DETAIL><CONT><NO_CONT>123</NO_CONT><KD_CONT_UKURAN>20</KD_CONT_UKURAN><FL_SETUJU>Y</FL_SETUJU></CONT><CONT><NO_CONT>223</NO_CONT><KD_CONT_UKURAN>20</KD_CONT_UKURAN><FL_SETUJU>T</FL_SETUJU></CONT></DETAIL></RESPONLCL><RESPONLCL><HEADER><KD_GUDANG_ASAL>CART</KD_GUDANG_ASAL><KD_GUDANG_TUJUAN>207X</KD_GUDANG_TUJUAN><KD_ORGANISASI>1</KD_ORGANISASI><EMAIL>CUSTOMERS@EDI-INDONESIA.CO.ID</EMAIL><NPWP>000000000000000</NPWP><NAMA_KAPAL>5VFT67B</NAMA_KAPAL><NO_VOY_FLIGHT>768</NO_VOY_FLIGHT><NO_BC11>6789</NO_BC11><ALASAN_TOLAK>KONTAINER SUDAH PERNAH DIAJUKAN</ALASAN_TOLAK></HEADER><DETAIL><CONT><NO_CONT>AS</NO_CONT><KD_CONT_UKURAN>20</KD_CONT_UKURAN><FL_SETUJU>T</FL_SETUJU></CONT></DETAIL></RESPONLCL></DOCUMENT>

<?xml version="1.0" encoding="UTF-8"?> <DOCUMENT> <RESPONLCL> <HEADER> <NO_UBAH_STATUS>ST20170220142600</NO_UBAH_STATUS> <KD_GUDANG_ASAL>CART</KD_GUDANG_ASAL> <KD_GUDANG_TUJUAN>207X</KD_GUDANG_TUJUAN> <NM_LENGKAP>SUPER ADMINISTRATOR APLIKASI</NM_LENGKAP> <KD_ORGANISASI>1</KD_ORGANISASI> <NAMA_ORGANISASI></NAMA_ORGANISASI> <ALAMAT>WISMA SMR 10TH JLN. YOS SUDARSO KAV. 89 JAKARTA UTARA</ALAMAT> <EMAIL>CUSTOMERS@EDI-INDONESIA.CO.ID</EMAIL> <NPWP>000000000000000</NPWP> <NOTELP>0000000</NOTELP> <NOFAX>00000000000000</NOFAX> <NAMA_KAPAL>HUMAM</NAMA_KAPAL> <NO_VOY_FLIGHT>345</NO_VOY_FLIGHT> <TGL_TIBA>2017-02-14</TGL_TIBA> <NO_BC11>345</NO_BC11> <TGL_BC11>2017-03-02</TGL_BC11> <TGL_UBAH_STATUS>2017-03-01 10:43:42</TGL_UBAH_STATUS> <ALASAN_TOLAK>KONTAINER SUDAH PERNAH MENDAFTAR</ALASAN_TOLAK> </HEADER> <DETAIL> <KONTAINER> <NO_CONT>123</NO_CONT> <KD_CONT_UKURAN>20</KD_CONT_UKURAN> <FL_SETUJU>Y</FL_SETUJU> </KONTAINER> <KONTAINER> <NO_CONT>223</NO_CONT> <KD_CONT_UKURAN>20</KD_CONT_UKURAN> <FL_SETUJU>T</FL_SETUJU> </KONTAINER> </DETAIL> </RESPONLCL> <RESPONLCL> <HEADER> <NO_UBAH_STATUS>ST20170221113035</NO_UBAH_STATUS> <KD_GUDANG_ASAL>CART</KD_GUDANG_ASAL> <KD_GUDANG_TUJUAN>207X</KD_GUDANG_TUJUAN> <NM_LENGKAP>SUPER ADMINISTRATOR APLIKASI</NM_LENGKAP> <KD_ORGANISASI>1</KD_ORGANISASI><NAMA_ORGANISASI> </NAMA_ORGANISASI><ALAMAT>WISMA SMR 10TH JLN. YOS SUDARSO KAV. 89 JAKARTA UTARA</ALAMAT> <EMAIL>CUSTOMERS@EDI-INDONESIA.CO.ID</EMAIL> <NPWP>000000000000000</NPWP> <NOTELP>0000000</NOTELP> <NOFAX>00000000000000</NOFAX> <NAMA_KAPAL>5VFT67B</NAMA_KAPAL> <NO_VOY_FLIGHT>768</NO_VOY_FLIGHT> <TGL_TIBA>2017-02-14</TGL_TIBA> <NO_BC11>6789</NO_BC11> <TGL_BC11>2017-02-22</TGL_BC11> <TGL_UBAH_STATUS>2017-02-21 13:29:49</TGL_UBAH_STATUS> <ALASAN_TOLAK>KONTAINER SUDAH PERNAH MENDAFTAR</ALASAN_TOLAK> </HEADER> <DETAIL> <KONTAINER> <NO_CONT>AS</NO_CONT> <KD_CONT_UKURAN>20</KD_CONT_UKURAN> <FL_SETUJU>T</FL_SETUJU> </KONTAINER> </DETAIL> </RESPONLCL> </DOCUMENT>

<?xml version="1.0" encoding="UTF-8"?>
<DOCUMENT>
<RESPONLCL>
<HEADER>
<NO_UBAH_STATUS>ST20170220142600</NO_UBAH_STATUS>
<KD_GUDANG_ASAL>CART</KD_GUDANG_ASAL>
<KD_GUDANG_TUJUAN>207X</KD_GUDANG_TUJUAN>
<NM_LENGKAP>SUPER ADMINISTRATOR APLIKASI</NM_LENGKAP>
<KD_ORGANISASI>1</KD_ORGANISASI>
<NAMA_ORGANISASI></NAMA_ORGANISASI>
<ALAMAT>WISMA SMR 10TH JLN. YOS SUDARSO KAV. 89 JAKARTA UTARA</ALAMAT>
<EMAIL>CUSTOMERS@EDI-INDONESIA.CO.ID</EMAIL>
<NPWP>000000000000000</NPWP>
<NOTELP>0000000</NOTELP>
<NOFAX>00000000000000</NOFAX>
<NAMA_KAPAL>HUMAM</NAMA_KAPAL>
<NO_VOY_FLIGHT>345</NO_VOY_FLIGHT>
<TGL_TIBA>2017-02-14</TGL_TIBA>
<NO_BC11>345</NO_BC11>
<TGL_BC11>2017-03-02</TGL_BC11>
<TGL_UBAH_STATUS>2017-03-01 10:43:42</TGL_UBAH_STATUS>
<ALASAN_TOLAK>KONTAINER SUDAH PERNAH MENDAFTAR</ALASAN_TOLAK>
</HEADER>
<DETAIL>
<KONTAINER>
<NO_CONT>123</NO_CONT>
<KD_CONT_UKURAN>20</KD_CONT_UKURAN>
<FL_SETUJU>Y</FL_SETUJU>
</KONTAINER>
<KONTAINER>
<NO_CONT>223</NO_CONT>
<KD_CONT_UKURAN>20</KD_CONT_UKURAN>
<FL_SETUJU>T</FL_SETUJU>
</KONTAINER>
</DETAIL>
</RESPONLCL>
<RESPONLCL>
<HEADER>
<NO_UBAH_STATUS>ST20170221113035</NO_UBAH_STATUS>
<KD_GUDANG_ASAL>CART</KD_GUDANG_ASAL>
<KD_GUDANG_TUJUAN>207X</KD_GUDANG_TUJUAN>
<NM_LENGKAP>SUPER ADMINISTRATOR APLIKASI</NM_LENGKAP>
<KD_ORGANISASI>1</KD_ORGANISASI><NAMA_ORGANISASI>
</NAMA_ORGANISASI><ALAMAT>WISMA SMR 10TH JLN. YOS SUDARSO KAV. 89 JAKARTA UTARA</ALAMAT>
<EMAIL>CUSTOMERS@EDI-INDONESIA.CO.ID</EMAIL>
<NPWP>000000000000000</NPWP>
<NOTELP>0000000</NOTELP>
<NOFAX>00000000000000</NOFAX>
<NAMA_KAPAL>5VFT67B</NAMA_KAPAL>
<NO_VOY_FLIGHT>768</NO_VOY_FLIGHT>
<TGL_TIBA>2017-02-14</TGL_TIBA>
<NO_BC11>6789</NO_BC11>
<TGL_BC11>2017-02-22</TGL_BC11>
<TGL_UBAH_STATUS>2017-02-21 13:29:49</TGL_UBAH_STATUS>
<ALASAN_TOLAK>KONTAINER SUDAH PERNAH MENDAFTAR</ALASAN_TOLAK>
</HEADER>
<DETAIL>
<KONTAINER>
<NO_CONT>AS</NO_CONT>
<KD_CONT_UKURAN>20</KD_CONT_UKURAN>
<FL_SETUJU>T</FL_SETUJU>
</KONTAINER>
</DETAIL>
</RESPONLCL>
</DOCUMENT>

















<?php
set_time_limit(3600);
require_once("config.php");


$method = 'RESPONLCL';
$filename = $CONF['root.dir'] . "CheckScheduler/" . $method . ".txt";
$main = new main($CONF, $conn);
$CheckFile = $main->CheckFile($filename);


if (!$CheckFile) {
	
	$main->connect();
	
$SQL = "SELECT * FROM app_log_server WHERE METHOD='".$method."' AND XML_RESPONSE IS NOT NULL AND REMARKS IS NULL";
$Query = $conn->query($SQL);
 if ($Query->size() > 0) {
	         while ($Query->next()) {
            $ID_SERVER = $Query->get("ID");
            $XML_RESPONSE = $Query->get("XML_RESPONSE");
            $xml = xml2ary($XML_RESPONSE);
            if (count($xml) > 0) {
                $xml = $xml['DOCUMENT']['_c'];
                $countLCL = count($xml['RESPONLCL']);
                if ($countLCL > 1) {
                    for ($c = 0; $c < $countLCL; $c++) {
                        $RESPONLCL = $xml['RESPONLCL'][$c]['_c'];
                        UpdateRESPONLCL($RESPONLCL);
                    }
                } elseif ($countLCL == 1) {
                    $RESPONLCL = $xml['RESPONLCL']['_c'];
                    UpdateRESPONLCL($RESPONLCL);
                }
            }
$SQL = "UPDATE app_log_server SET REMARKS = 'DATA BERHASIL DI EKSTRAK', WK_REKAM = NOW()
                    WHERE ID = '" . $ID_SERVER . "'";
            $Execute = $conn->execute($SQL);
        }
	}
	  else {
        echo 'data tidak ada.';
    }
    //END

    $main->connect(false);
    $main->removeFile($filename);
}
else {
    echo 'Scheduler sedang berjalan, harap menghapus file ' . $method . '.txt yang ada difolder CheckScheduler.';
}
	
	
function UpdateRESPONLCL($RESPONLCL) {
    global $CONF, $conn;
    $header = $RESPONLCL['HEADER']['_c'];
    $KD_GUDANG_ASAL = trim($header['KD_GUDANG_ASAL']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($header['KD_GUDANG_ASAL']['_v'])) . "'";
    $KD_GUDANG_TUJUAN = trim($header['KD_GUDANG_TUJUAN']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($header['KD_GUDANG_TUJUAN']['_v'])) . "'";
    $KD_ORGANISASI = trim($header['KD_ORGANISASI']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($header['KD_ORGANISASI']['_v'])) . "'";
    $EMAIL = trim($header['EMAIL']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($header['EMAIL']['_v'])) . "'";
    $NAMA_KAPAL = trim($header['NAMA_KAPAL']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($header['NAMA_KAPAL']['_v'])) . "'";
    $NO_VOY_FLIGHT = trim($header['NO_VOY_FLIGHT']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($header['NO_VOY_FLIGHT']['_v'])) . "'";
    $NO_BC11 = trim($header['NO_BC11']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($header['NO_BC11']['_v'])) . "'";
    $ALASAN_TOLAK = trim($header['ALASAN_TOLAK']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($header['ALASAN_TOLAK']['_v'])) . "'";
	
	$SQL = "SELECT A.NO_UBAH_STATUS 
	FROM t_ubah_status A INNER JOIN app_user B ON A.ID_USER=B.ID INNER JOIN t_organisasi C ON B.KD_ORGANISASI=C.ID
	INNER JOIN reff_gudang E ON A.KD_GUDANG_ASAL=E.KD_GUDANG
	WHERE A.KD_GUDANG_ASAL='".$KD_GUDANG_ASAL."' 
	AND A.KD_GUDANG_TUJUAN='".$KD_GUDANG_TUJUAN."'
	AND B.KD_ORGANISASI='".$KD_ORGANISASI."' 
	AND A.NAMA_KAPAL='".$NAMA_KAPAL."' 
	AND A.NO_VOY_FLIGHT = '".$NO_VOY_FLIGHT."' 
	AND A.NO_BC11 = '".$NO_BC11."'";
$Query = $conn->query($SQL);
 if ($Query->size() > 0) {
	 while ($Query->next()) {
			$detil = $RESPONLCL['DETIL']['_c'];
            //PERUBAHAN KONTAINER
            $countCONT = count($detil['CONT']);
            if ($countCONT > 1) {
                for ($d = 0; $d < $countCONT; $d++) {
                    $CONT = $detil['CONT'][$d]['_c'];
                    UpdateKontainerLCL($Query->get("NO_UBAH_STATUS"),$ALASAN_TOLAK);
                }
            } 
			elseif ($countCONT == 1) {
                $CONT = $detil['CONT']['_c'];
                UpdateKontainerLCL($Query->get("NO_UBAH_STATUS"),$ALASAN_TOLAK);
            }  
	 }
 }
else
{
return false;
}	
 
}

function UpdateKontainerLCL($KODE,$ALASAN_TOLAK) {
    global $CONF, $conn;
    $NO_CONT = trim($CONT['NO_CONT']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($CONT['NO_CONT']['_v'])) . "'";
    $FL_SETUJU = trim($CONT['FL_SETUJU']['_v']) == "" ? "NULL" : "'" . strtoupper(trim($CONT['FL_SETUJU']['_v'])) . "'";
if($FL_SETUJU == 'Y')
{
	$STATUS = '1';
}
elseif($FL_SETUJU == 'T')
{
	$STATUS = '2';
}

    $SQL = "SELECT ID FROM t_no_kontainer WHERE NO_UBAH_STATUS='".$KODE."' AND NO_CONT='".$NO_CONT."' AND STATUS='0'";
    $QueryDetail = $conn->query($SQL);
    if ($QueryDetail->size() == 1) {
       $SQL2 = "UPDATE t_no_kontainer SET WK_REKAM=NOW() , KETERANGAN='".$ALASAN_TOLAK."', STATUS='".$STATUS."'
	   WHERE NO_UBAH_STATUS='".$KODE."' AND NO_CONT='".$NO_CONT."'";
        $UPDATE = $conn->execute($SQL2);		 
		 		 
    }
	else
	{
		return false;
	}
}
    
?>




